<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FxPro AI Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    <style>
        /* Kaydƒ±rma √ßubuƒüu √∂zelle≈ütirme */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* YANIP S√ñNME ANƒ∞MASYONLARI */
        @keyframes flashGreen {
            0% { background-color: rgba(34, 197, 94, 0.5); } /* Parlak Ye≈üil */
            100% { background-color: transparent; }
        }
        @keyframes flashRed {
            0% { background-color: rgba(239, 68, 68, 0.5); } /* Parlak Kƒ±rmƒ±zƒ± */
            100% { background-color: transparent; }
        }
        .flash-up { animation: flashGreen 1s ease-out; }
        .flash-down { animation: flashRed 1s ease-out; }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans h-screen flex flex-col overflow-hidden">

    <nav class="bg-gray-800 border-b border-gray-700 px-6 py-3 flex justify-between items-center shrink-0 z-20">
        <div class="flex items-center gap-3">
            <span class="text-2xl">‚ö°</span>
            <h1 class="text-xl font-bold tracking-wider text-blue-400">FxPro <span class="text-white">AI</span></h1>
        </div>
        <div class="flex gap-4 text-sm items-center">
            <span class="text-gray-400 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Sistem Online
            </span>

            {% if user.is_authenticated %}
                <div class="flex items-center gap-3 ml-4 border-l border-gray-700 pl-4">
                    <span class="text-gray-300 font-bold">{{ user.username }}</span>
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white px-3 py-1.5 rounded transition text-xs">√áIKI≈û</button>
                    </form>
                </div>
            {% else %}
                <div class="flex gap-2 ml-4">
                    <a href="{% url 'login' %}" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded transition">Giri≈ü</a>
                    <a href="{% url 'register' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition font-bold">Kayƒ±t Ol</a>
                </div>
            {% endif %}
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">

        <aside class="w-72 bg-gray-800 border-r border-gray-700 flex flex-col z-10">
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <h3 class="text-gray-400 text-xs uppercase font-bold tracking-widest">ƒ∞zleme Listesi</h3>
            </div>
            
            <ul class="flex-1 overflow-y-auto p-3 space-y-2">
                {% for varlik in varliklar %}
                <li onclick="veriyiGuncelle('{{ varlik.sembol }}', '{{ varlik.isim }}')" 
                    class="group flex justify-between items-center p-3 bg-gray-700/20 border border-gray-700/50 rounded-xl cursor-pointer hover:bg-blue-600 hover:border-blue-500 transition-all">
                    <div class="flex flex-col overflow-hidden mr-2">
                        <span class="font-bold text-sm text-gray-200 group-hover:text-white truncate">{{ varlik.isim }}</span>
                        <span class="text-[10px] text-gray-500 group-hover:text-blue-200 font-mono">{{ varlik.sembol }}</span>
                    </div>
                    <span class="text-[9px] font-bold bg-gray-900 text-gray-400 px-2 py-1 rounded border border-gray-600 group-hover:border-blue-400 shrink-0">
                        {{ varlik.kategori }}
                    </span>
                </li>
                {% endfor %}
            </ul>

            {% if portfoy_var %}
            <div class="mt-auto p-4 bg-gray-900 border-t border-gray-700">
                <div class="bg-gradient-to-r from-gray-800 to-gray-700 rounded-xl p-4 border border-gray-600 shadow-lg">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">üíº Portf√∂y Durumu</h4>
                    
                    <div class="flex justify-between items-end mb-1">
                        <span class="text-gray-300 text-sm">Toplam Varlƒ±k</span>
                        <span class="text-xl font-bold text-white">${{ toplam_deger }}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400 text-xs">Net K√¢r/Zarar</span>
                        <span class="font-bold {{ genel_durum_renk }}">
                            {{ toplam_kar }}$
                        </span>
                    </div>

                    <div class="mt-3 pt-3 border-t border-gray-600 space-y-1">
                        {% for p in portfoy_detay %}
                        <div class="flex justify-between text-[10px]">
                            <span class="text-gray-300">{{ p.isim }}</span>
                            <span class="{{ p.durum_renk }}">{{ p.kar_zarar_yuzde }}%</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="p-4 border-t border-gray-700 bg-gray-800">
                <a href="/admin/analiz/varlik/add/" target="_blank" 
                   class="flex items-center justify-center gap-2 w-full bg-gray-700 hover:bg-blue-600 text-sm font-medium text-white py-2 rounded-lg transition-colors border border-gray-600 hover:border-blue-500">
                   <span>‚ûï</span> Yeni Varlƒ±k
                </a>
            </div>
        </aside>

        <main class="flex-1 p-6 overflow-y-auto bg-gray-900 relative">
            
            <div id="loading" class="hidden absolute top-4 right-4 bg-blue-600 text-white text-xs px-3 py-1 rounded-full animate-pulse z-50 shadow-lg">
                Veri G√ºncelleniyor...
            </div>

            <div class="flex justify-between items-end mb-6 pb-4 border-b border-gray-800">
                <div>
                    <h2 id="baslik_sembol" class="text-3xl font-black tracking-tight text-white">Y√ºkleniyor...</h2>
                    <p class="text-gray-400 text-sm mt-1">Canlƒ± Analiz Raporu</p>
                </div>
                <div class="text-right">
                    <p id="fiyat_degeri" class="text-5xl font-black text-white tracking-tighter">---</p>
                    <p id="degisim_degeri" class="text-lg font-medium mt-1">---</p>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-5 mb-6">
                <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 hover:border-blue-500 transition">
                    <h3 class="text-gray-400 text-xs uppercase font-bold tracking-wider">Yapay Zeka Sinyali</h3>
                    <p id="ai_karar" class="text-2xl font-bold mt-2">---</p>
                    <div class="mt-2 flex items-center gap-2">
                        <div class="flex-1 h-1.5 bg-gray-700 rounded-full overflow-hidden">
                            <div id="rsi_bar" class="h-full bg-blue-500 w-1/2 transition-all duration-500"></div>
                        </div>
                        <span id="rsi_deger" class="text-xs text-gray-400">RSI: --</span>
                    </div>
                </div>
                <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 hover:border-blue-500 transition">
                    <h3 class="text-gray-400 text-xs uppercase font-bold tracking-wider">Haber Analizi</h3>
                    <p id="haber_durumu" class="text-2xl font-bold text-blue-400 mt-2">---</p>
                    <p class="text-xs text-gray-500 mt-1">Global piyasa duygu durumu</p>
                </div>
                <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 hover:border-blue-500 transition">
                    <h3 class="text-gray-400 text-xs uppercase font-bold tracking-wider">AI Hedef (24s)</h3>
                    <p id="tahmin_fiyat" class="text-2xl font-bold text-white mt-2">---</p>
                    <div class="flex justify-between items-end">
                        <p id="tahmin_yonu" class="text-xs font-bold mt-1">---</p>
                        
                        <div class="text-right">
                            <span class="text-[10px] text-gray-500 block">Model G√ºveni</span>
                            <span id="basari_skoru" class="text-sm font-bold text-purple-400">---</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mb-3">
                <button onclick="detayliAnalizAc()" class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-lg hover:shadow-purple-500/50 border border-purple-500/30">
                    <span class="text-lg">üß†</span> Detaylƒ± AI Raporu & Hedef
                </button>
            </div>

            <div class="bg-gray-800 border border-gray-700 rounded-xl overflow-hidden h-[550px] shadow-2xl relative">
                <div id="tradingview_chart" class="w-full h-full"></div>
            </div>
        </main>

        <aside class="w-80 bg-gray-900 border-l border-gray-700 hidden xl:flex flex-col h-full z-10">
            <div class="flex-1 flex flex-col min-h-0 border-b border-gray-800">
                <div class="p-4 bg-gray-800">
                    <h3 class="text-white text-xs font-bold uppercase tracking-wider flex items-center gap-2">
                        üìÖ Ekonomik Takvim
                    </h3>
                </div>
                <div class="flex-1 relative bg-gray-900 overflow-hidden">
                    <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
                        <div class="tradingview-widget-container__widget" style="height: 100%; width: 100%;"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
                        {
                        "width": "100%",
                        "height": "100%",
                        "colorTheme": "dark",
                        "isTransparent": true,
                        "locale": "tr",
                        "importanceFilter": "-1,0,1",
                        "currencyFilter": "USD,EUR,TRY,GBP,XAU"
                        }
                        </script>
                    </div>
                </div>
            </div>
            
            <div class="h-64 bg-gray-800/20 flex flex-col">
                <div class="p-3 border-t border-b border-gray-800 bg-gray-800">
                    <h3 class="text-white text-xs font-bold uppercase tracking-wider">
                        üåç Piyasa √ñzeti
                    </h3>
                </div>
                <div class="flex-1 relative overflow-hidden">
                    <div class="tradingview-widget-container" style="height: 100%; width: 100%;">
                        <div class="tradingview-widget-container__widget" style="height: 100%; width: 100%;"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-market-overview.js" async>
                        {
                        "colorTheme": "dark",
                        "dateRange": "12M",
                        "showChart": false,
                        "locale": "tr",
                        "largeChartUrl": "",
                        "isTransparent": true,
                        "showSymbolLogo": true,
                        "width": "100%",
                        "height": "100%",
                        "tabs": [
                            {
                            "title": "Pariteler",
                            "symbols": [
                                { "s": "FX:EURUSD", "d": "EUR/USD" },
                                { "s": "FX:USDTRY", "d": "USD/TRY" },
                                { "s": "FX:GBPUSD", "d": "GBP/USD" },
                                { "s": "OANDA:XAUUSD", "d": "ALTIN" }
                            ]
                            }
                        ]
                        }
                        </script>
                    </div>
                </div>
            </div>
        </aside>

    </div>

    <div id="detayModal" class="hidden fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-gray-800 w-full max-w-5xl rounded-2xl border border-gray-700 shadow-2xl relative animate-[fadeIn_0.3s_ease-out]">
            <button onclick="document.getElementById('detayModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-white text-xl bg-gray-700/50 w-8 h-8 rounded-full flex items-center justify-center transition">‚úï</button>
            
            <div class="p-6">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-3xl">üß†</span>
                    <h3 class="text-2xl font-bold text-white">Yapay Zeka Teknik Raporu</h3>
                </div>
                <p class="text-gray-400 text-sm mb-6 pl-12 border-l-2 border-purple-500">
                    Gradient Boosting Model Tahmini ‚Ä¢ Trend Analizi ‚Ä¢ Yarƒ±nki Hedef Fiyat (Mor Yƒ±ldƒ±z)
                </p>
                
                <div id="modalGrafikAlani" class="w-full h-[500px] flex items-center justify-center bg-gray-900/50 rounded-xl border border-gray-700/50">
                    <span class="text-gray-500 animate-pulse flex items-center gap-2">
                        <svg class="animate-spin h-5 w-5 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        AI Grafiƒüi Olu≈üturuluyor...
                    </span>
                </div>
                <div class="mt-6 px-4">
                    <h4 class="text-white font-bold mb-3 flex items-center gap-2">
                        <span>üìä</span> Son 3 G√ºn√ºn Yapay Zeka Karnesi
                    </h4>
                    <div id="modalTabloAlani" class="bg-gray-900/50 rounded-xl border border-gray-700/50 overflow-hidden">
                        <p class="text-gray-500 p-4 text-xs">Hesaplanƒ±yor...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            veriyiGuncelle('{{ secili_sembol }}', 'Varsayƒ±lan');
        });

        window.seciliSembolGlobal = '{{ secili_sembol }}';

        setInterval(function() {
            if(window.seciliSembolGlobal) {
                console.log("Oto Pilot: Veri g√ºncelleniyor...");
                veriyiGuncelle(window.seciliSembolGlobal, 'Guncelleme'); 
            }
        }, 30000);

        function veriyiGuncelle(sembol, isim) {
            window.seciliSembolGlobal = sembol;

            if(isim !== 'Guncelleme') {
                document.getElementById('loading').classList.remove('hidden');
                if(isim !== 'Varsayƒ±lan') document.getElementById('baslik_sembol').innerText = isim;
            }

            fetch(`/api/get_data/?sembol=${sembol}`)
                .then(response => response.json())
                .then(data => {
                    if(data.error) return;

                    // --- 1. YANIP S√ñNME EFEKTƒ∞ (FLASHING) BA≈ûLANGI√á ---
                    const fiyatElem = document.getElementById('fiyat_degeri');
                    
                    // Eski fiyatƒ± al (Sayƒ±ya √ßevirerek)
                    // Eƒüer sayfa ilk a√ßƒ±lƒ±yorsa veya deƒüer '---' ise 0 kabul et
                    let eskiFiyatText = fiyatElem.innerText.replace('$', '').trim();
                    let eskiFiyat = parseFloat(eskiFiyatText);
                    if (isNaN(eskiFiyat)) eskiFiyat = 0;

                    const yeniFiyat = parseFloat(data.fiyat);

                    // Fiyatƒ± ekrana yaz
                    fiyatElem.innerText = `$${data.fiyat}`;

                    // Efekt Sƒ±nƒ±flarƒ±nƒ± Temizle ve Yeniden Tetikle
                    fiyatElem.classList.remove('flash-up', 'flash-down');
                    void fiyatElem.offsetWidth; // Animasyonu resetlemek i√ßin Hack

                    // Kar≈üƒ±la≈ütƒ±rma yap ve renk ver
                    if (yeniFiyat > eskiFiyat && eskiFiyat !== 0) {
                        fiyatElem.classList.add('flash-up');   // Ye≈üil Yak
                    } else if (yeniFiyat < eskiFiyat && eskiFiyat !== 0) {
                        fiyatElem.classList.add('flash-down'); // Kƒ±rmƒ±zƒ± Yak
                    }
                    // --- YANIP S√ñNME EFEKTƒ∞ Bƒ∞Tƒ∞≈û ---

                    // --- 2. Dƒ∞ƒûER VERƒ∞LERƒ∞ G√úNCELLE ---
                    const degisimElem = document.getElementById('degisim_degeri');
                    degisimElem.innerText = `%${data.degisim}`;
                    degisimElem.className = data.degisim_pozitif ? 'text-lg font-medium mt-1 text-green-400' : 'text-lg font-medium mt-1 text-red-400';

                    const kararElem = document.getElementById('ai_karar');
                    kararElem.innerText = data.karar;
                    kararElem.className = `text-2xl font-bold mt-2 ${data.karar_class}`;

                    document.getElementById('rsi_deger').innerText = `RSI: ${data.rsi}`;
                    const rsiBar = document.getElementById('rsi_bar');
                    rsiBar.style.width = `${data.rsi}%`;
                    rsiBar.className = `h-full transition-all duration-500 ${data.rsi > 70 ? 'bg-red-500' : data.rsi < 30 ? 'bg-green-500' : 'bg-blue-500'}`;

                    document.getElementById('haber_durumu').innerText = data.haber_durumu;
                    
                    // --- 3. AI HEDEF VE BA≈ûARI SKORU (YENƒ∞ EKLENEN KISIM) ---
                    document.getElementById('tahmin_fiyat').innerText = `$${data.tahmin}`;
                    
                    // Eƒüer ba≈üarƒ± skoru HTML'de varsa g√ºncelle (Hata almamak i√ßin kontrol)
                    const skorElem = document.getElementById('basari_skoru');
                    if(skorElem && data.basari_skoru) {
                        skorElem.innerText = data.basari_skoru;
                    }
                    // --------------------------------------------------------

                    const tahminYonElem = document.getElementById('tahmin_yonu');
                    tahminYonElem.innerText = data.tahmin_yonu;
                    tahminYonElem.className = data.tahmin_yonu.includes("Y√úKSELƒ∞≈û") ? "text-xs font-bold mt-1 text-green-400" : "text-xs font-bold mt-1 text-red-400";

                    if(isim !== 'Guncelleme') {
                        grafigiGuncelle(data.tradingview_symbol);
                    }
                })
                .catch(err => console.error("Hata:", err))
                .finally(() => {
                    document.getElementById('loading').classList.add('hidden');
                });
        }

        function grafigiGuncelle(tvSembol) {
            document.getElementById('tradingview_chart').innerHTML = "";
            new TradingView.widget({
                "autosize": true,
                "symbol": tvSembol,
                "interval": "D",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "tr",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "allow_symbol_change": false,
                "container_id": "tradingview_chart"
            });
        }

        // --- DETAYLI ANALƒ∞Z FONKSƒ∞YONU ---
        function detayliAnalizAc() {
            const sembol = window.seciliSembolGlobal;
            const modal = document.getElementById('detayModal');
            const grafikAlani = document.getElementById('modalGrafikAlani');
            const tabloAlani = document.getElementById('modalTabloAlani'); // YENƒ∞
            
            modal.classList.remove('hidden');
            
            grafikAlani.innerHTML = '<span class="text-gray-500 animate-pulse flex items-center gap-2">AI Grafiƒüi Olu≈üturuluyor...</span>';
            if(tabloAlani) tabloAlani.innerHTML = '<p class="text-gray-500 p-4 text-xs">Analiz yapƒ±lƒ±yor...</p>'; // YENƒ∞
            
            fetch(`/api/get_details/?sembol=${sembol}`)
                .then(res => res.json())
                .then(data => {
                    if(data.error) {
                        grafikAlani.innerHTML = '<span class="text-red-500 font-bold">Veri alƒ±namadƒ±.</span>';
                        return;
                    }
                    
                    grafikAlani.innerHTML = data.grafik_html;
                    
                    // YENƒ∞: Tabloyu yerle≈ütir
                    if(tabloAlani && data.karne_html) {
                        tabloAlani.innerHTML = data.karne_html;
                    }
                    
                    // Plotly Scriptlerini Yeniden √áalƒ±≈ütƒ±r
                    Array.from(grafikAlani.querySelectorAll('script')).forEach( oldScript => {
                        const newScript = document.createElement("script");
                        Array.from(oldScript.attributes).forEach( attr => newScript.setAttribute(attr.name, attr.value) );
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });

                    // Resize i≈ülemi
                    setTimeout(() => {
                        const plotDiv = grafikAlani.querySelector('.plotly-graph-div');
                        if (plotDiv) Plotly.Plots.resize(plotDiv);
                    }, 200);
                })
                .catch(err => {
                    console.error(err);
                    grafikAlani.innerHTML = '<span class="text-red-500">Baƒülantƒ± hatasƒ±!</span>';
                });
        }
    </script>
</body>
</html>